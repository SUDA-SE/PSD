<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDS å¤šæ¨¡æ€æ™ºèƒ½è¯Šæ–­ç³»ç»Ÿ</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/nifti-reader-js@0.5.4/release/current/nifti-reader.js"></script>

    <style>
        /* ---------------- 1. åŸºç¡€æ ·å¼ä¸å˜é‡ ---------------- */
        :root {
            --primary: #0ea5e9;       
            --primary-dark: #0369a1;  
            --accent: #8b5cf6;        
            --danger: #f43f5e;        
            --success: #10b981;       
            --bg-gradient: radial-gradient(circle at 10% 20%, rgb(239, 246, 255) 0%, rgb(219, 234, 254) 90%);
            --glass-bg: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(255, 255, 255, 0.95);
            --shadow-soft: 0 8px 30px rgba(0, 0, 0, 0.04);
            --text-main: #0f172a;
            --text-sub: #475569; 
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 18px; } 
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg-gradient);
            color: var(--text-main);
            min-height: 100vh;
            line-height: 1.6;
            font-size: 1rem; 
        }

        /* éšè—ç±»ï¼Œç”¨äºé¡µé¢åˆ‡æ¢ */
        .hidden { display: none !important; }

        /* ---------------- 2. å¯¼èˆªæ  ---------------- */
        nav {
            padding: 1.2rem 5%;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--glass-border);
            position: sticky; top: 0; z-index: 100;
        }
        .logo-box { display: flex; align-items: center; gap: 10px; }
        .logo-icon { font-size: 1.8rem; } 
        .logo-text { font-weight: 800; font-size: 1.6rem; color: var(--primary-dark); letter-spacing: -0.5px; } 
        .version-badge {
            padding: 8px 20px; 
            background: rgba(255,255,255,0.8); border-radius: 30px;
            font-size: 0.95rem; font-weight: 600; color: var(--primary-dark);
            border: 1px solid rgba(255,255,255,0.5);
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }

        /* ---------------- 3. ä¸»é¡µå¸ƒå±€ ---------------- */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 2rem; } 
        .header-section { text-align: center; padding: 4rem 1rem 3rem; }
        .main-title {
            font-size: 3.8rem; font-weight: 800; color: var(--text-main);
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
        }
        .sub-title { font-size: 1.25rem; color: var(--text-sub); font-weight: 500; max-width: 800px; margin: 0 auto; }

        /* ---------------- 4. ç»ç’ƒå¡ç‰‡é€šç”¨ ---------------- */
        .glass-card {
            background: var(--glass-bg); backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: 24px;
            box-shadow: var(--shadow-soft);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        /* ---------------- 5. è¡¨å•åŒºåŸŸ ---------------- */
        .patient-bar { display: flex; gap: 2.5rem; padding: 2rem 3rem; align-items: flex-end; margin-bottom: 2.5rem; flex-wrap: wrap; }
        .input-wrapper { flex: 1; min-width: 240px; }
        .label-style { display: block; font-size: 0.95rem; font-weight: 700; color: var(--text-sub); margin-bottom: 0.8rem; }
        .input-field {
            width: 100%; padding: 0.9rem 1.2rem;
            border: 2px solid #cbd5e1; border-radius: 12px;
            background: rgba(255, 255, 255, 0.6);
            font-size: 1.15rem; color: var(--text-main); transition: 0.2s;
        }
        .input-field:focus { border-color: var(--primary); background-color: #fff; outline: none; box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.15); }

        /* ---------------- 6. ä¸Šä¼ åŒºåŸŸ ---------------- */
        .upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2.5rem; margin-bottom: 4rem; }
        @media (max-width: 768px) { .upload-grid { grid-template-columns: 1fr; } }

        .upload-card { padding: 2rem; display: flex; flex-direction: column; height: 100%; border-top: 5px solid transparent; position: relative; }
        .card-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 1rem; }
        .card-title { font-weight: 700; color: var(--text-main); font-size: 1.3rem; }
        .tag { font-size: 0.85rem; padding: 6px 12px; border-radius: 8px; font-weight: 700; }
        .tag-blue { background: #e0f2fe; color: #0284c7; }
        .tag-purple { background: #f3e8ff; color: #7e22ce; }

        .drop-zone {
            flex-grow: 1; min-height: 200px; 
            background: rgba(255,255,255,0.5);
            border: 3px dashed #cbd5e1; border-radius: 16px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; cursor: pointer; transition: 0.2s; padding: 1.5rem;
        }
        .drop-zone:hover { border-color: var(--primary); background: #fff; }
        .drop-zone.active { background: #f0fdf4; border-color: var(--success); border-style: solid; }

        .file-info { margin-top: 15px; font-size: 0.9rem; color: var(--success); font-weight: bold; display: none;}
        
        /* é¢„è§ˆæŒ‰é’® (ä¸Šä¼ åæ˜¾ç¤º) */
        .btn-preview-trigger {
            margin-top: 15px;
            padding: 10px 20px;
            background: var(--text-main);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: none; /* é»˜è®¤éšè— */
            transition: all 0.2s;
        }
        .btn-preview-trigger:hover { transform: scale(1.05); background: #000; }

        /* ---------------- 7. æ–°å¢ï¼šé¢„è§ˆè¯¦æƒ…é¡µ (Full Page View) ---------------- */
        #view-preview {
            padding: 2rem 0;
            animation: fadeIn 0.4s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .preview-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 2rem;
        }
        .btn-back {
            background: rgba(255,255,255,0.5); border: 1px solid #cbd5e1;
            padding: 0.6rem 1.5rem; border-radius: 10px; cursor: pointer;
            font-weight: 600; display: flex; align-items: center; gap: 8px;
            transition: 0.2s;
        }
        .btn-back:hover { background: #fff; border-color: var(--primary); color: var(--primary); }

        .preview-content {
            display: flex; gap: 2rem; justify-content: center; flex-wrap: wrap;
        }
        .viewer-box {
            background: #000;
            border-radius: 16px;
            padding: 10px;
            width: 512px; 
            max-width: 100%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            position: relative;
        }
        .viewer-canvas-container {
            position: relative;
            width: 100%;
            padding-bottom: 100%; /* Square aspect ratio */
            background: #111;
            overflow: hidden;
            border-radius: 8px;
        }
        .viewer-canvas-container canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: contain;
        }
        .viewer-controls {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 15px; color: #fff;
        }
        .btn-save-img {
            background: var(--primary); color: white; border: none;
            padding: 6px 15px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;
        }
        .viewer-title {
            position: absolute; top: 20px; left: 20px;
            background: rgba(0,0,0,0.6); color: white;
            padding: 4px 10px; border-radius: 4px; font-size: 0.85rem; pointer-events: none;
        }
        .mask-legend {
            position: absolute; bottom: 20px; right: 20px;
            background: rgba(0,0,0,0.6); color: #ff6b6b; border: 1px solid #ff6b6b;
            padding: 4px 10px; border-radius: 4px; font-size: 0.85rem; pointer-events: none;
        }

        /* ---------------- 8. åº•éƒ¨æ“ä½œæ  ---------------- */
        .btn-area { text-align: center; margin: 4rem 0; }
        .magic-btn {
            background: linear-gradient(135deg, var(--primary) 0%, #3b82f6 100%);
            color: white; border: none; padding: 1.4rem 5rem; 
            border-radius: 60px; font-size: 1.25rem; font-weight: 700;
            cursor: pointer; box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.5);
            transition: all 0.3s; letter-spacing: 1px;
        }
        .magic-btn:hover { transform: translateY(-3px) scale(1.03); box-shadow: 0 20px 40px -5px rgba(59, 130, 246, 0.6); }

        /* ---------------- 9. ç»“æœä¸Loading ---------------- */
        #resultPanel { display: none; margin-top: 2rem; padding: 3.5rem; margin-bottom: 5rem; }
        /* (åŸæœ‰çš„ç»“æœæ ·å¼ä¿ç•™) */
        .result-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 2.5rem; padding-bottom: 1.5rem; border-bottom: 2px dashed #cbd5e1; }
        .data-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2.5rem; margin-bottom: 3rem; }
        .data-card { background: #fff; border-radius: 20px; padding: 2.5rem 1.5rem; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        .d-icon { font-size: 2.2rem; margin-bottom: 0.8rem; display: block; }
        .d-val { font-size: 3.5rem; font-weight: 800; color: var(--text-main); line-height: 1.1; margin-bottom: 0.5rem; }
        .d-label { font-size: 1.05rem; color: var(--text-sub); font-weight: 600; }
        .ai-box { background: linear-gradient(to right, #fffbeb, #fff); border-left: 6px solid #f59e0b; padding: 2rem; border-radius: 16px; display: flex; gap: 20px; align-items: start; }

        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.92); backdrop-filter: blur(10px);
            z-index: 999; display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        .spin-icon { font-size: 4.5rem; animation: spin 1s infinite linear; margin-bottom: 1.5rem; color: var(--primary); }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <nav>
        <div class="logo-box">
            <span class="logo-icon">ğŸ’ </span>
            <span class="logo-text">PDS</span>
        </div>
        <div class="version-badge">PDS Multimodal v1.0</div>
    </nav>

    <div id="view-home" class="container">
        <header class="header-section">
            <h1 class="main-title">å‰åˆ—è…ºç™Œæ™ºèƒ½è¯Šæ–­</h1>
            <div class="sub-title">ç»“åˆä¸´åºŠç”Ÿç‰©æ ‡å¿—ç‰©ä¸åŒ»ç–—å½±åƒçš„å¤šæ¨¡æ€ AI è¾…åŠ©è¯Šæ–­å¹³å°</div>
        </header>

        <section class="glass-card patient-bar">
            <div class="input-wrapper">
                <label class="label-style">ğŸ‘¤ ç—…äººå§“å / Name</label>
                <input type="text" id="pName" class="input-field" placeholder="è¯·è¾“å…¥...">
            </div>
            <div class="input-wrapper">
                <label class="label-style">ğŸ‚ å¹´é¾„ / Age (å²)</label>
                <input type="number" id="pAge" class="input-field" placeholder="ä¾‹å¦‚: 65">
            </div>
            <div class="input-wrapper">
                <label class="label-style">ğŸ©¸å‰åˆ—è…ºç‰¹å¼‚æ€§æŠ—åŸ / PSA  (ng/ml)</label>
                <input type="number" step="0.1" id="pPSA" class="input-field" placeholder="ä¾‹å¦‚: 8.5">
            </div>
        </section>

        <div class="upload-grid">
            
            <div class="glass-card upload-card" style="border-top-color: var(--primary);">
                <div class="card-head">
                    <div class="card-title">å½±åƒçª—å£ MRI</div>
                    <span class="tag tag-blue">DWI / T2W</span>
                </div>
                <div class="drop-zone" onclick="document.getElementById('file1').click()">
                    <div class="upload-hint">ç‚¹å‡»ä¸Šä¼  MRI å‹ç¼©åŒ…</div>
                    <div class="upload-sub">æ”¯æŒ .zip, .7z (å«å›¾åƒä¸æ©è†œ .nii)</div>
                    <div class="file-info" id="info1"></div>
                </div>
                <button class="btn-preview-trigger" id="btnPreview1" onclick="switchToPreview('mri')">
                    ğŸ‘ï¸ é¢„è§ˆ MRI å½±åƒ & æ©è†œ
                </button>
                <input type="file" id="file1" hidden accept=".zip,.7z,.rar" onchange="handleFileSelect(this, 'mri')">
            </div>

            <div class="glass-card upload-card" style="border-top-color: var(--accent);">
                <div class="card-head">
                    <div class="card-title">å½±åƒçª—å£ PSMA PET/CT</div>
                    <span class="tag tag-purple">PET / CT</span>
                </div>
                <div class="drop-zone" onclick="document.getElementById('file2').click()">
                    <div class="upload-hint">ç‚¹å‡»ä¸Šä¼  PSMA å‹ç¼©åŒ…</div>
                    <div class="upload-sub">æ”¯æŒ .zip, .7z (å«å›¾åƒä¸æ©è†œ .nii)</div>
                    <div class="file-info" id="info2"></div>
                </div>
                <button class="btn-preview-trigger" id="btnPreview2" onclick="switchToPreview('psma')">
                    ğŸ‘ï¸ é¢„è§ˆ PSMA å½±åƒ & æ©è†œ
                </button>
                <input type="file" id="file2" hidden accept=".zip,.7z,.rar" onchange="handleFileSelect(this, 'psma')">
            </div>

        </div>

        <div class="btn-area">
            <button class="magic-btn" onclick="startAI()">å¼€å§‹ AI å¤šæ¨¡æ€èåˆè¯Šæ–­</button>
        </div>

        <section id="resultPanel" class="glass-card">
            <div class="result-header">
                <div>
                    <h2 style="font-size: 1.8rem; color: var(--text-main); font-weight: 800;">AI è¯Šæ–­æŠ¥å‘Šå•</h2>
                    <p style="font-size: 1rem; color: var(--text-sub);">æŠ¥å‘Šç¼–å·: #2025-PDS-AUTO-09</p>
                </div>
                <div style="text-align: right; font-size: 1.1rem; color: var(--text-sub);">
                    ç—…äºº: <span id="resName" style="font-weight: 700; color: var(--text-main);">--</span>
                </div>
            </div>

            <div class="data-grid">
                <div class="data-card">
                    <span class="d-icon">ğŸ“ˆ</span>
                    <div class="d-val" style="color: var(--danger);" id="rRisk">--</div>
                    <div class="d-label">AI æ¶æ€§æ¦‚ç‡ (Risk)</div>
                </div>
                <div class="data-card">
                    <span class="d-icon">ğŸ”¢</span>
                    <div class="d-val" style="color: var(--primary);" id="rGleason">--</div>
                    <div class="d-label">Gleason é¢„æµ‹åˆ†çº§</div>
                </div>
                <div class="data-card">
                    <span class="d-icon">ğŸ“Š</span>
                    <div class="d-val" style="color: var(--accent);" id="rPSA">--</div>
                    <div class="d-label">PSA è¾“å…¥å€¼</div>
                </div>
            </div>

            <div class="ai-box">
                <div style="font-size: 2.2rem;">ğŸ’¡</div>
                <div>
                    <h4 style="margin-bottom: 0.8rem; font-size: 1.25rem;">æ™ºèƒ½ç»¼åˆå†³ç­–æ„è§ï¼š</h4>
                    <p style="font-size: 1.1rem; color: #334155; line-height: 1.7;">
                        æ¨¡å‹èåˆäº† MRI/ADC å½±åƒç‰¹å¾ä¸ PSA ç”Ÿç‰©æ ‡å¿—ç‰©æ•°æ®ã€‚æ£€æµ‹åˆ°å¤–å‘¨å¸¦å­˜åœ¨ç–‘ä¼¼ CS-PCa ç—…ç¶åŒºåŸŸã€‚
                    </p>
                </div>
            </div>
        </section>
        
        <footer style="text-align: center; padding: 2rem; color: #aaa;">
            &copy; 2025 PDS AI Lab. æœ¬ç³»ç»Ÿç»“æœä»…ä¾›ç§‘ç ”å‚è€ƒã€‚
        </footer>
    </div>

    <div id="view-preview" class="container hidden">
        <div class="preview-header">
            <h2 style="font-size: 2rem; color: var(--primary-dark);">å½±åƒé¢„è§ˆå·¥ä½œå°</h2>
            <button class="btn-back" onclick="backToHome()">
                <span>â¬…ï¸ è¿”å›è¯Šæ–­ä¸»é¡µ</span>
            </button>
        </div>

        <div class="preview-content">
            <div class="viewer-box">
                <div class="viewer-title" id="previewTitle">MRI Image View</div>
                <div class="mask-legend">çº¢è‰²åŒºåŸŸ: Mask æ©è†œ</div>
                
                <div class="viewer-canvas-container">
                    <canvas id="canvasBase"></canvas>
                    <canvas id="canvasMask" style="pointer-events: none; opacity: 0.6;"></canvas>
                </div>

                <div class="viewer-controls">
                    <div id="sliceInfo">Slice: Center</div>
                    <div>
                        <button class="btn-save-img" onclick="downloadPreview('png')">ä¿å­˜ä¸º PNG</button>
                        <button class="btn-save-img" onclick="downloadPreview('jpg')" style="background:#555">JPG</button>
                    </div>
                </div>
            </div>
            
            <div style="width: 300px; color: var(--text-sub);">
                <h3 style="color: var(--text-main); margin-bottom: 10px;">æ–‡ä»¶è¯¦æƒ…</h3>
                <ul id="fileDetails" style="list-style: none; background: rgba(255,255,255,0.6); padding: 15px; border-radius: 12px;">
                    <li>ç­‰å¾…æ•°æ®åŠ è½½...</li>
                </ul>
                <p style="margin-top: 15px; font-size: 0.9rem;">
                    * é¢„è§ˆå±•ç¤ºçš„æ˜¯ 3D å½±åƒçš„ä¸­é—´åˆ‡ç‰‡ã€‚<br>
                    * çº¢è‰²åŒºåŸŸè¡¨ç¤º AI æˆ–åŒ»ç”Ÿæ ‡æ³¨çš„æ„Ÿå…´è¶£åŒºåŸŸ (ROI/Mask)ã€‚
                </p>
            </div>
        </div>
    </div>

    <div class="overlay" id="loader">
        <div class="spin-icon">âš™ï¸</div>
        <h3 id="loaderText" style="color: var(--primary-dark); font-weight: 700; font-size: 1.5rem;">æ­£åœ¨å¤„ç†...</h3>
    </div>

    <script>
        // å…¨å±€æ•°æ®å­˜å‚¨
        const appData = {
            mri: { base: null, mask: null, fileName: '' },
            psma: { base: null, mask: null, fileName: '' },
            currentType: null // 'mri' or 'psma'
        };

        // ---------------- 1. æ–‡ä»¶å¤„ç†é€»è¾‘ ----------------
        async function handleFileSelect(input, type) {
            const file = input.files[0];
            if (!file) return;

            showLoader(true, "æ­£åœ¨è§£å‹å¹¶è§£æ .nii æ–‡ä»¶...");
            
            try {
                // 1. è§£å‹ Zip
                const zip = new JSZip();
                const zipContent = await zip.loadAsync(file);
                
                // 2. å¯»æ‰¾ .nii æ–‡ä»¶
                const niiFiles = [];
                for (let filename in zipContent.files) {
                    if (filename.endsWith('.nii') || filename.endsWith('.nii.gz')) {
                        niiFiles.push({
                            name: filename,
                            data: await zipContent.files[filename].async("arraybuffer")
                        });
                    }
                }

                if (niiFiles.length < 1) {
                    alert("é”™è¯¯ï¼šå‹ç¼©åŒ…å†…æœªæ‰¾åˆ° .nii æ–‡ä»¶ï¼");
                    showLoader(false);
                    return;
                }

                // 3. ç®€å•çš„å¯å‘å¼è§„åˆ™åŒºåˆ† Mask å’Œ Base å›¾åƒ
                // å‡è®¾ï¼šæ–‡ä»¶è¾ƒå°çš„å¾€å¾€æ˜¯ Mask (å› ä¸ºåªæœ‰0/1)ï¼Œæˆ–è€…æ–‡ä»¶ååŒ…å« mask/label
                // è¿™é‡Œä¸ºäº†ç¨³å¥ï¼Œç›´æ¥æŒ‰å¤§å°æ’åºï¼Œå¤§çš„å½“åº•å›¾ï¼Œå°çš„å½“Maskï¼ˆå¦‚æœæœ‰ä¸¤ä¸ªçš„è¯ï¼‰
                niiFiles.sort((a, b) => b.data.byteLength - a.data.byteLength);

                const baseFile = niiFiles[0];
                const maskFile = niiFiles.length > 1 ? niiFiles[1] : null;

                // å­˜å‚¨åˆ°å…¨å±€å˜é‡
                appData[type].base = baseFile;
                appData[type].mask = maskFile;
                appData[type].fileName = file.name;

                // UI æ›´æ–°
                document.getElementById(type === 'mri' ? 'info1' : 'info2').innerText = `âœ… ${file.name} (å« ${niiFiles.length} ä¸ªNIfTI)`;
                document.getElementById(type === 'mri' ? 'info1' : 'info2').style.display = 'block';
                document.getElementById(type === 'mri' ? 'btnPreview1' : 'btnPreview2').style.display = 'inline-block';

            } catch (err) {
                console.error(err);
                alert("æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥å‹ç¼©åŒ…æ ¼å¼ã€‚");
            } finally {
                showLoader(false);
            }
        }

        // ---------------- 2. è§†å›¾åˆ‡æ¢ä¸æ¸²æŸ“é€»è¾‘ ----------------
        function switchToPreview(type) {
            appData.currentType = type;
            const data = appData[type];
            
            if(!data.base) {
                alert("è¯·å…ˆä¸Šä¼ æ–‡ä»¶");
                return;
            }

            // åˆ‡æ¢ DOM æ˜¾ç¤º
            document.getElementById('view-home').classList.add('hidden');
            document.getElementById('view-preview').classList.remove('hidden');

            // æ›´æ–°æ ‡é¢˜
            document.getElementById('previewTitle').innerText = type === 'mri' ? "MRI å½±åƒé¢„è§ˆ" : "PSMA PET/CT é¢„è§ˆ";
            
            // æ›´æ–°æ–‡ä»¶è¯¦æƒ…åˆ—è¡¨
            const detailHtml = `
                <li><strong>æ–‡ä»¶å:</strong> ${data.fileName}</li>
                <li><strong>å›¾åƒæº:</strong> ${data.base.name}</li>
                <li><strong>æ©è†œæº:</strong> ${data.mask ? data.mask.name : 'æœªæ£€æµ‹åˆ°æ©è†œ'}</li>
            `;
            document.getElementById('fileDetails').innerHTML = detailHtml;

            // æ¸²æŸ“ Canvas
            renderNiftiToCanvas(data.base.data, 'canvasBase', false); // æ¸²æŸ“åº•å›¾
            if (data.mask) {
                renderNiftiToCanvas(data.mask.data, 'canvasMask', true); // æ¸²æŸ“æ©è†œ
            } else {
                clearCanvas('canvasMask');
            }
        }

        function backToHome() {
            document.getElementById('view-preview').classList.add('hidden');
            document.getElementById('view-home').classList.remove('hidden');
        }

        // ---------------- 3. NIfTI æ ¸å¿ƒæ¸²æŸ“å‡½æ•° ----------------
        function renderNiftiToCanvas(arrayBuffer, canvasId, isMask) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');

            if (nifti.isCompressed(arrayBuffer)) {
                arrayBuffer = nifti.decompress(arrayBuffer);
            }

            if (nifti.isNIFTI(arrayBuffer)) {
                const header = nifti.readHeader(arrayBuffer);
                const image = nifti.readImage(header, arrayBuffer);

                // è·å–ç»´åº¦
                const cols = header.dims[1];
                const rows = header.dims[2];
                const slices = header.dims[3];

                // è®¾ç½® Canvas å¤§å° (ç»Ÿä¸€æ‹‰ä¼¸åˆ°å®¹å™¨å¤§å°ï¼Œæˆ–ä¿æŒæ¯”ä¾‹)
                canvas.width = cols;
                canvas.height = rows;

                // å–ä¸­é—´åˆ‡ç‰‡
                const midSlice = Math.floor(slices / 2);
                document.getElementById('sliceInfo').innerText = `Slice: ${midSlice} / ${slices}`;

                // è¯»å–æ•°æ®å¹¶æ ¹æ®ç±»å‹è½¬æ¢
                let typedData;
                if (header.datatypeCode === nifti.NIFTI1.TYPE_UINT8) {
                    typedData = new Uint8Array(image);
                } else if (header.datatypeCode === nifti.NIFTI1.TYPE_INT16) {
                    typedData = new Int16Array(image);
                } else if (header.datatypeCode === nifti.NIFTI1.TYPE_FLOAT32) {
                    typedData = new Float32Array(image);
                } else {
                    typedData = new Uint8Array(image); // Fallback
                }

                // è®¡ç®—åˆ‡ç‰‡åœ¨æ•°ç»„ä¸­çš„åç§»é‡
                const sliceSize = cols * rows;
                const sliceOffset = sliceSize * midSlice;

                // åˆ›å»º ImageData ç”¨äºç»˜åˆ¶
                const canvasImageData = ctx.createImageData(cols, rows);
                const data = canvasImageData.data;

                // å¯»æ‰¾æœ€å¤§å€¼ä»¥ä¾¿å½’ä¸€åŒ–æ˜¾ç¤º (ç®€å•å¯¹æ¯”åº¦æ‹‰ä¼¸)
                let maxVal = 0;
                for (let i = 0; i < sliceSize; i++) {
                    if (typedData[sliceOffset + i] > maxVal) maxVal = typedData[sliceOffset + i];
                }
                if(maxVal === 0) maxVal = 1; // é˜²æ­¢é™¤0

                for (let i = 0; i < sliceSize; i++) {
                    let val = typedData[sliceOffset + i];
                    
                    // å½’ä¸€åŒ–åˆ° 0-255
                    let pixel = (val / maxVal) * 255;

                    const pIndex = i * 4;

                    if (isMask) {
                        // å¦‚æœæ˜¯æ©è†œï¼šåªæ˜¾ç¤ºé0åŒºåŸŸï¼Œä¸”æ˜¾ç¤ºä¸ºçº¢è‰²
                        if (val > 0) {
                            data[pIndex] = 255;     // R
                            data[pIndex + 1] = 0;   // G
                            data[pIndex + 2] = 0;   // B
                            data[pIndex + 3] = 255; // Alpha (å®Œå…¨ä¸é€æ˜ï¼Œé€šè¿‡CSS opacityæ§åˆ¶æ•´ä½“é€æ˜åº¦)
                        } else {
                            data[pIndex + 3] = 0;   // é€æ˜
                        }
                    } else {
                        // å¦‚æœæ˜¯åº•å›¾ï¼šç°åº¦æ˜¾ç¤º
                        data[pIndex] = pixel;
                        data[pIndex + 1] = pixel;
                        data[pIndex + 2] = pixel;
                        data[pIndex + 3] = 255;
                    }
                }

                ctx.putImageData(canvasImageData, 0, 0);
            }
        }

        function clearCanvas(id) {
            const cvs = document.getElementById(id);
            const ctx = cvs.getContext('2d');
            ctx.clearRect(0,0,cvs.width, cvs.height);
        }

        // ---------------- 4. å¯¼å‡ºå›¾ç‰‡åŠŸèƒ½ ----------------
        function downloadPreview(format) {
            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶ Canvas å°† Base å’Œ Mask åˆå¹¶ï¼Œå› ä¸ºç°åœ¨æ˜¯ä¸¤ä¸ªåˆ†å¼€çš„Canvas
            const baseCvs = document.getElementById('canvasBase');
            const maskCvs = document.getElementById('canvasMask');
            
            const tempCvs = document.createElement('canvas');
            tempCvs.width = baseCvs.width;
            tempCvs.height = baseCvs.height;
            const ctx = tempCvs.getContext('2d');

            // ç»˜åˆ¶åº•å›¾
            ctx.drawImage(baseCvs, 0, 0);
            // ç»˜åˆ¶ Mask (å¸¦é€æ˜åº¦)
            ctx.globalAlpha = 0.6; 
            ctx.drawImage(maskCvs, 0, 0);

            const link = document.createElement('a');
            link.download = `PDS_Preview_${appData.currentType}.${format}`;
            link.href = tempCvs.toDataURL(`image/${format}`);
            link.click();
        }

        // ---------------- 5. è¾…åŠ©åŠŸèƒ½ ----------------
        function showLoader(show, text="PDS ç¥ç»ç½‘ç»œæ­£åœ¨è®¡ç®—...") {
            const l = document.getElementById('loader');
            document.getElementById('loaderText').innerText = text;
            l.style.display = show ? 'flex' : 'none';
        }

        // åŸæœ‰çš„ startAI é€»è¾‘
        function startAI() {
            const name = document.getElementById('pName').value;
            const psa = document.getElementById('pPSA').value;
            
            if(!name || !psa) return alert('è¯·å¡«å†™å®Œæ•´çš„ä¸´åºŠä¿¡æ¯ï¼ˆå§“åã€PSAï¼‰');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶ (ç®€å•æ£€æŸ¥)
            if(!appData.mri.base && !appData.psma.base) return alert('è¯·è‡³å°‘ä¸Šä¼ å¹¶è§£æä¸€ä»½å½±åƒæ–‡ä»¶');

            showLoader(true, "æå–ç‰¹å¾ â” å¤šæ¨¡æ€èåˆ â” ç”ŸæˆæŠ¥å‘Š");

            setTimeout(() => {
                showLoader(false);
                document.getElementById('resName').innerText = name;
                document.getElementById('rPSA').innerText = psa;
                document.getElementById('rRisk').innerText = "92%";
                document.getElementById('rGleason').innerText = "4+5";
                
                const res = document.getElementById('resultPanel');
                res.style.display = 'block';
                res.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 2000);
        }
    </script>
</body>
</html>